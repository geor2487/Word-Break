<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Break - ã‚†ã‚‹ã‚„ã‹å˜èªå­¦ç¿’</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    @keyframes shake { 
      0%, 100% { transform: translateX(0); } 
      25% { transform: translateX(-5px); } 
      75% { transform: translateX(5px); } 
    }
    @keyframes bounce { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-10px); } 
    }
    @keyframes pulse { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.5; } 
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const wordDatabase = {
      toeic: {
        easy: [
          { word: 'meeting', meaning: 'ä¼šè­°', example: 'We have a [___] at 3 PM.' },
          { word: 'office', meaning: 'ã‚ªãƒ•ã‚£ã‚¹', example: 'I work in an [___] downtown.' },
          { word: 'schedule', meaning: 'äºˆå®š', example: 'Check your [___] for today.' },
          { word: 'report', meaning: 'å ±å‘Šæ›¸', example: 'Please submit the [___] by Friday.' },
          { word: 'client', meaning: 'é¡§å®¢', example: 'The [___] was satisfied with our service.' },
          { word: 'budget', meaning: 'äºˆç®—', example: 'We need to stay within [___].' },
          { word: 'deadline', meaning: 'ç· ã‚åˆ‡ã‚Š', example: 'The [___] is next Monday.' },
          { word: 'confirm', meaning: 'ç¢ºèªã™ã‚‹', example: 'Please [___] your attendance.' },
          { word: 'attend', meaning: 'å‡ºå¸­ã™ã‚‹', example: 'Will you [___] the conference?' },
          { word: 'available', meaning: 'åˆ©ç”¨å¯èƒ½ãª', example: 'Is this room [___]?' },
          { word: 'document', meaning: 'æ›¸é¡', example: 'Sign the [___] here.' },
          { word: 'department', meaning: 'éƒ¨ç½²', example: 'Which [___] do you work in?' },
          { word: 'employee', meaning: 'å¾“æ¥­å“¡', example: 'We have 50 [___]s.' },
          { word: 'purchase', meaning: 'è³¼å…¥ã™ã‚‹', example: 'I need to [___] supplies.' },
          { word: 'invoice', meaning: 'è«‹æ±‚æ›¸', example: 'The [___] was sent yesterday.' },
        ],
        normal: [
          { word: 'implement', meaning: 'å®Ÿæ–½ã™ã‚‹', example: 'We will [___] the new system next month.' },
          { word: 'negotiate', meaning: 'äº¤æ¸‰ã™ã‚‹', example: 'They are [___]ing the contract terms.' },
          { word: 'compliance', meaning: 'æ³•ä»¤éµå®ˆ', example: '[___] with regulations is essential.' },
          { word: 'acquisition', meaning: 'è²·å', example: 'The [___] was completed last week.' },
          { word: 'revenue', meaning: 'åç›Š', example: '[___] increased by 20% this quarter.' },
          { word: 'quarterly', meaning: 'å››åŠæœŸã®', example: 'We have [___] reviews.' },
          { word: 'delegate', meaning: 'å§”ä»»ã™ã‚‹', example: 'Learn to [___] tasks effectively.' },
          { word: 'reimburse', meaning: 'æ‰•ã„æˆ»ã™', example: 'We will [___] your travel expenses.' },
          { word: 'fluctuate', meaning: 'å¤‰å‹•ã™ã‚‹', example: 'Prices [___] based on demand.' },
          { word: 'tentative', meaning: 'æš«å®šçš„ãª', example: 'This is a [___] schedule.' },
          { word: 'premises', meaning: 'æ•·åœ°', example: 'No smoking on the [___].' },
          { word: 'subsidiary', meaning: 'å­ä¼šç¤¾', example: 'They opened a [___] in Asia.' },
          { word: 'audit', meaning: 'ç›£æŸ»', example: 'The annual [___] is next week.' },
          { word: 'liability', meaning: 'è² å‚µ', example: 'We need to reduce our [___].' },
          { word: 'prospective', meaning: 'è¦‹è¾¼ã¿ã®ã‚ã‚‹', example: 'We met with [___] clients.' },
        ],
        hard: [
          { word: 'remuneration', meaning: 'å ±é…¬', example: 'The [___] package is competitive.' },
          { word: 'arbitration', meaning: 'ä»²è£', example: 'The dispute went to [___].' },
          { word: 'liquidation', meaning: 'æ¸…ç®—', example: 'The company went into [___].' },
          { word: 'indemnity', meaning: 'è£œå„Ÿ', example: 'The contract includes an [___] clause.' },
          { word: 'consortium', meaning: 'å…±åŒäº‹æ¥­ä½“', example: 'A [___] of banks funded the project.' },
          { word: 'stipulate', meaning: 'è¦å®šã™ã‚‹', example: 'The contract [___]s the payment terms.' },
          { word: 'amortize', meaning: 'å„Ÿå´ã™ã‚‹', example: 'We [___] the cost over five years.' },
          { word: 'fiduciary', meaning: 'å—è¨—è€…ã®', example: 'Directors have [___] duties.' },
          { word: 'proprietary', meaning: 'å°‚æœ‰ã®', example: 'This is [___] technology.' },
          { word: 'expedite', meaning: 'è¿…é€Ÿã«å‡¦ç†ã™ã‚‹', example: 'Please [___] the shipment.' },
          { word: 'commensurate', meaning: 'é‡£ã‚Šåˆã£ãŸ', example: 'Salary [___] with experience.' },
          { word: 'mitigate', meaning: 'è»½æ¸›ã™ã‚‹', example: 'We need to [___] the risks.' },
          { word: 'collateral', meaning: 'æ‹…ä¿', example: 'The loan requires [___].' },
          { word: 'adjudicate', meaning: 'è£å®šã™ã‚‹', example: 'The court will [___] the matter.' },
          { word: 'rescind', meaning: 'æ’¤å›ã™ã‚‹', example: 'They decided to [___] the offer.' },
        ]
      },
      idiom: {
        easy: [
          { word: 'break the ice', meaning: 'å ´ã‚’å’Œã¾ã›ã‚‹', example: 'He told a joke to [___].' },
          { word: 'piece of cake', meaning: 'ç°¡å˜ãªã“ã¨', example: 'The test was a [___].' },
          { word: 'hit the road', meaning: 'å‡ºç™ºã™ã‚‹', example: "It's time to [___]." },
          { word: 'catch up', meaning: 'è¿‘æ³ã‚’è©±ã™', example: "Let's [___] over coffee." },
          { word: 'hang out', meaning: 'éŠã¶', example: 'We [___] at the mall.' },
          { word: 'work out', meaning: 'é‹å‹•ã™ã‚‹', example: 'I [___] every morning.' },
          { word: 'figure out', meaning: 'ç†è§£ã™ã‚‹', example: "I can't [___] this problem." },
          { word: 'look forward to', meaning: 'æ¥½ã—ã¿ã«ã™ã‚‹', example: "I'm [___] the trip." },
          { word: 'get along', meaning: 'ä»²è‰¯ãã™ã‚‹', example: 'They [___] very well.' },
          { word: 'run out of', meaning: 'ä½¿ã„æœãŸã™', example: 'We [___] milk.' },
          { word: 'give up', meaning: 'è«¦ã‚ã‚‹', example: "Don't [___]!" },
          { word: 'take care of', meaning: 'ä¸–è©±ã‚’ã™ã‚‹', example: 'I [___] my plants.' },
          { word: 'come up with', meaning: 'æ€ã„ã¤ã', example: 'She [___] a great idea.' },
          { word: 'put off', meaning: 'å»¶æœŸã™ã‚‹', example: "Don't [___] your homework." },
          { word: 'turn out', meaning: 'çµå±€ã€œã«ãªã‚‹', example: 'It [___] to be a great day.' },
        ],
        normal: [
          { word: 'on the same page', meaning: 'åŒã˜èªè­˜', example: "Let's make sure we're [___]." },
          { word: 'under the weather', meaning: 'ä½“èª¿ãŒæ‚ªã„', example: "I'm feeling [___] today." },
          { word: 'cost an arm and a leg', meaning: 'éå¸¸ã«é«˜ä¾¡', example: 'That car [___].' },
          { word: 'the ball is in your court', meaning: 'æ±ºå®šæ¨©ã¯ã‚ãªãŸã«', example: "I've made my offer. [___]." },
          { word: 'back to square one', meaning: 'æŒ¯ã‚Šå‡ºã—ã«æˆ»ã‚‹', example: 'We are [___].' },
          { word: 'beat around the bush', meaning: 'é å›ã—ã«è¨€ã†', example: "Stop [___] and tell me." },
          { word: 'blessing in disguise', meaning: 'ä¸å¹¸ä¸­ã®å¹¸ã„', example: 'It was a [___].' },
          { word: 'burn the midnight oil', meaning: 'å¤œé…ãã¾ã§åƒã', example: "I've been [___] to finish this." },
          { word: 'cut to the chase', meaning: 'æœ¬é¡Œã«å…¥ã‚‹', example: "Let's [___]." },
          { word: 'get out of hand', meaning: 'æ‰‹ã«è² ãˆãªããªã‚‹', example: 'The situation [___].' },
          { word: 'hit the nail on the head', meaning: 'çš„ã‚’å°„ã‚‹', example: 'You [___].' },
          { word: 'in the same boat', meaning: 'åŒã˜å¢ƒé‡', example: "We're all [___]." },
          { word: 'jump on the bandwagon', meaning: 'æ™‚æµã«ä¹—ã‚‹', example: 'Everyone [___].' },
          { word: 'keep your chin up', meaning: 'å…ƒæ°—ã‚’å‡ºã™', example: '[___]! Things will get better.' },
          { word: 'a piece of the pie', meaning: 'å–ã‚Šåˆ†', example: 'Everyone wants [___].' },
        ],
        hard: [
          { word: 'barking up the wrong tree', meaning: 'è¦‹å½“é•ã„', example: "You're [___]." },
          { word: 'beat a dead horse', meaning: 'ç„¡é§„ãªç¹°ã‚Šè¿”ã—', example: "Let's not [___]." },
          { word: 'bite the bullet', meaning: 'å›°é›£ã«ç«‹ã¡å‘ã‹ã†', example: 'I had to [___] and apologize.' },
          { word: 'burn bridges', meaning: 'é–¢ä¿‚ã‚’æ–­ã¤', example: "Don't [___] with your former employer." },
          { word: 'get cold feet', meaning: 'æ€–æ°—ã¥ã', example: 'He [___] before the presentation.' },
          { word: 'go the extra mile', meaning: 'æœŸå¾…ä»¥ä¸Šã«é ‘å¼µã‚‹', example: 'She always [___] for clients.' },
          { word: 'let the cat out of the bag', meaning: 'ç§˜å¯†ã‚’æ¼ã‚‰ã™', example: 'Who [___]?' },
          { word: 'once in a blue moon', meaning: 'ã‚ã£ãŸã«ãªã„', example: 'I see him [___].' },
          { word: 'read between the lines', meaning: 'è¡Œé–“ã‚’èª­ã‚€', example: 'You need to [___].' },
          { word: 'spill the beans', meaning: 'ç§˜å¯†ã‚’ã°ã‚‰ã™', example: "Don't [___] about the party." },
          { word: 'steal thunder', meaning: 'æ‰‹æŸ„ã‚’æ¨ªå–ã‚Š', example: 'She [___] at the meeting.' },
          { word: 'the elephant in the room', meaning: 'è¦‹ã¦è¦‹ã¬ãµã‚Šã®å•é¡Œ', example: "Let's address [___]." },
          { word: 'throw in the towel', meaning: 'é™å‚ã™ã‚‹', example: "I'm ready to [___]." },
          { word: 'when pigs fly', meaning: 'ã‚ã‚Šå¾—ãªã„', example: "He'll clean his room [___]." },
          { word: 'add insult to injury', meaning: 'æ³£ãã£é¢ã«èœ‚', example: 'To [___], it rained.' },
        ]
      }
    };

    const CHAT_SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€ŒWord Breakã€ã¨ã„ã†å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒªã®ä¸­ã«ã„ã‚‹ã€å„ªã—ãã¦è¦ªã—ã¿ã‚„ã™ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

å½¹å‰²ï¼š
- ä½œæ¥­ã®åˆé–“ã«æ¯æŠœãã§ãŠã—ã‚ƒã¹ã‚Šã«æ¥ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©±ã—ç›¸æ‰‹ã«ãªã‚‹
- ç–²ã‚Œã‚„ä¸å®‰ã€æ‚©ã¿ãŒã‚ã‚Œã°å…±æ„Ÿã—ã€å‰å‘ããªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã™ã‚‹
- è‹±èªå­¦ç¿’ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹
- ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã§ä¼šè©±ã™ã‚‹

ãƒˆãƒ¼ãƒ³ï¼š
- æ¸©ã‹ãã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã€æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªã„
- é©åº¦ã«çµµæ–‡å­—ã‚’ä½¿ã†ï¼ˆä½¿ã„ã™ããªã„ï¼‰
- çŸ­ã‚ã®è¿”ç­”ã‚’å¿ƒãŒã‘ã‚‹ï¼ˆ2-3æ–‡ç¨‹åº¦ï¼‰
- æ—¥æœ¬èªã§ä¼šè©±ã™ã‚‹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½œæ¥­ã‚„å‹‰å¼·ã®åˆé–“ã«æ¥ã¦ã„ã‚‹ã®ã§ã€é•·ã™ãã‚‹è¿”ç­”ã¯é¿ã‘ã€æ°—è»½ã«è©±ã›ã‚‹é›°å›²æ°—ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚`;

    const generateFeedback = (results, category, level) => {
      const correctRate = results.filter(r => r.correct).length / results.length * 100;
      const wrongWords = results.filter(r => !r.correct);
      let feedback = { message: '', advice: '', encouragement: '' };
      const categoryName = category === 'toeic' ? 'TOEICãƒ“ã‚¸ãƒã‚¹è‹±èª' : 'æ—¥å¸¸æ…£ç”¨è¡¨ç¾';
      
      if (correctRate === 100) {
        feedback.message = 'âœ¨ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼';
        feedback.advice = level === 'hard' 
          ? `${categoryName}ã®ä¸Šç´šãƒ¬ãƒ™ãƒ«ã§ã‚‚å®Œç’§ï¼å®Ÿéš›ã®ä¼šè©±ã§ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`
          : 'æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã«æŒ‘æˆ¦ã—ã¦ã¿ã¦ã¯ï¼Ÿ';
        feedback.encouragement = 'ç´ æ™´ã‚‰ã—ã„é›†ä¸­åŠ›ã§ã™ï¼';
      } else if (correctRate >= 70) {
        feedback.message = 'ğŸŒŸ ã‚ˆãã§ãã¾ã—ãŸï¼';
        const spellingTips = wrongWords.some(w => w.wasClose) 
          ? 'ã‚¹ãƒšãƒ«ãŒæƒœã—ã‹ã£ãŸï¼ç™ºéŸ³ã—ãªãŒã‚‰æ›¸ãã¨è¦šãˆã‚„ã™ã„ã§ã™ã‚ˆã€‚'
          : '';
        feedback.advice = `${spellingTips}é–“é•ãˆãŸè¡¨ç¾ã¯å£°ã«å‡ºã—ã¦ç·´ç¿’ã‚’ã€‚`;
        feedback.encouragement = 'ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†ï¼';
      } else if (correctRate >= 50) {
        feedback.message = 'ğŸ“š åŠåˆ†ä»¥ä¸Šæ­£è§£ï¼';
        feedback.advice = category === 'idiom' 
          ? 'ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã§è¦šãˆã‚‹ã¨å¿˜ã‚Œã«ãã„ã§ã™ã‚ˆã€‚'
          : 'ãƒ“ã‚¸ãƒã‚¹å˜èªã¯æ–‡è„ˆã¨ä¸€ç·’ã«è¦šãˆã¾ã—ã‚‡ã†ã€‚';
        feedback.encouragement = 'è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚';
      } else {
        feedback.message = 'ğŸŒ± å­¦ç¿’ã®ãƒãƒ£ãƒ³ã‚¹ï¼';
        feedback.advice = 'ãƒ¬ãƒ™ãƒ«ã‚’ä¸‹ã’ã¦åŸºç¤å›ºã‚ã‚‚è‰¯ã„æˆ¦ç•¥ã§ã™ã€‚';
        feedback.encouragement = 'é–“é•ã„ã¯å­¦ã³ã®ç¨®ï¼';
      }
      return feedback;
    };

    const getLevenshteinDistance = (s1, s2) => {
      const m = s1.length, n = s2.length;
      const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          dp[i][j] = s1[i-1] === s2[j-1] ? dp[i-1][j-1] : Math.min(dp[i-1][j-1], dp[i-1][j], dp[i][j-1]) + 1;
        }
      }
      return dp[m][n];
    };

    function WordBreakApp() {
      const [screen, setScreen] = useState('home');
      const [category, setCategory] = useState('toeic');
      const [level, setLevel] = useState('easy');
      const [timerMinutes, setTimerMinutes] = useState(30);
      const [timerSeconds, setTimerSeconds] = useState(0);
      const [isTimerRunning, setIsTimerRunning] = useState(false);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [questions, setQuestions] = useState([]);
      const [userInput, setUserInput] = useState('');
      const [results, setResults] = useState([]);
      const [showNotification, setShowNotification] = useState(false);
      const [showAnswer, setShowAnswer] = useState(false);
      const [lastAnswerResult, setLastAnswerResult] = useState(null);
      const [chatMessages, setChatMessages] = useState([
        { role: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼ä½œæ¥­ã®åˆé–“ã«ãŠã—ã‚ƒã¹ã‚Šã—ã¾ã›ã‚“ã‹ï¼ŸğŸŒ¿' }
      ]);
      const [chatInput, setChatInput] = useState('');
      const [isChatLoading, setIsChatLoading] = useState(false);
      const [learningStats, setLearningStats] = useState({ totalQuizzes: 0, correctAnswers: 0, totalQuestions: 0 });

      useEffect(() => {
        let interval;
        if (isTimerRunning) {
          interval = setInterval(() => {
            if (timerSeconds > 0) setTimerSeconds(s => s - 1);
            else if (timerMinutes > 0) { setTimerMinutes(m => m - 1); setTimerSeconds(59); }
            else { 
              setIsTimerRunning(false); 
              setShowNotification(true);
              if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('â˜• æ¯æŠœãã®æ™‚é–“ã§ã™ï¼', { body: 'å˜èªãƒ†ã‚¹ãƒˆã§æ°—åˆ†è»¢æ›ã—ã¾ã›ã‚“ã‹ï¼Ÿ' });
              }
            }
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [isTimerRunning, timerMinutes, timerSeconds]);

      useEffect(() => {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }, []);

      const startQuiz = useCallback(() => {
        const wordList = wordDatabase[category][level];
        const shuffled = [...wordList].sort(() => Math.random() - 0.5).slice(0, 10);
        const quizQuestions = shuffled.map(word => {
          const isE2J = Math.random() > 0.5;
          return {
            word: word.word, meaning: word.meaning, example: word.example,
            isEnglishToJapanese: isE2J,
            question: isE2J ? word.word : word.meaning,
            answer: isE2J ? word.meaning : word.word,
            questionLabel: isE2J ? 'å’Œè¨³ã—ã¦ãã ã•ã„' : 'è‹±è¨³ã—ã¦ãã ã•ã„'
          };
        });
        setQuestions(quizQuestions);
        setCurrentQuestion(0);
        setResults([]);
        setUserInput('');
        setShowAnswer(false);
        setLastAnswerResult(null);
        setScreen('quiz');
        setShowNotification(false);
      }, [category, level]);

      const handleSubmitAnswer = () => {
        const current = questions[currentQuestion];
        const userAnswer = userInput.trim().toLowerCase();
        const correctAnswer = current.answer.toLowerCase();
        const distance = getLevenshteinDistance(userAnswer, correctAnswer);
        const isCorrect = userAnswer === correctAnswer;
        const isClose = distance <= 2 && distance > 0;
        const result = {
          word: current.word, meaning: current.meaning, question: current.question,
          correctAnswer: current.answer, userAnswer: userInput.trim(),
          correct: isCorrect, wasClose: isClose, isEnglishToJapanese: current.isEnglishToJapanese
        };
        setLastAnswerResult(result);
        setShowAnswer(true);
        setResults([...results, result]);
      };

      const handleNextQuestion = () => {
        if (currentQuestion < questions.length - 1) {
          setCurrentQuestion(c => c + 1);
          setUserInput('');
          setShowAnswer(false);
          setLastAnswerResult(null);
        } else {
          setLearningStats(prev => ({
            totalQuizzes: prev.totalQuizzes + 1,
            correctAnswers: prev.correctAnswers + results.filter(r => r.correct).length,
            totalQuestions: prev.totalQuestions + results.length
          }));
          setScreen('result');
        }
      };

      const sendChat = async () => {
        if (!chatInput.trim() || isChatLoading) return;
        
        const userMessage = chatInput.trim();
        setChatInput('');
        setChatMessages(prev => [...prev, { role: 'user', text: userMessage }]);
        setIsChatLoading(true);
        
        try {
          const recentMessages = [...chatMessages.slice(-10), { role: 'user', text: userMessage }];
          const apiMessages = recentMessages.map(msg => ({
            role: msg.role === 'user' ? 'user' : 'assistant',
            content: msg.text
          }));
          
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 1000,
              system: CHAT_SYSTEM_PROMPT,
              messages: apiMessages
            })
          });
          
          const data = await response.json();
          const aiResponse = data.content?.[0]?.text || 'ã”ã‚ã‚“ãªã•ã„ã€ã†ã¾ãè¿”ç­”ã§ãã¾ã›ã‚“ã§ã—ãŸ ğŸ™';
          
          setChatMessages(prev => [...prev, { role: 'ai', text: aiResponse }]);
        } catch (error) {
          console.error('Chat error:', error);
          setChatMessages(prev => [...prev, { role: 'ai', text: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ ğŸ”„' }]);
        } finally {
          setIsChatLoading(false);
        }
      };

      const resetTimer = () => { setTimerMinutes(30); setTimerSeconds(0); setIsTimerRunning(true); setShowNotification(false); };

      const categoryNames = { toeic: 'TOEICãƒ»ãƒ“ã‚¸ãƒã‚¹', idiom: 'æ—¥å¸¸ãƒ»æ…£ç”¨è¡¨ç¾' };
      const levelNames = { easy: 'Easy', normal: 'Normal', hard: 'Hard' };
      const levelColors = { easy: '#4ade80', normal: '#facc15', hard: '#f87171' };
      const categoryColors = { toeic: '#60a5fa', idiom: '#c084fc' };

      const styles = {
        container: { minHeight: '100vh', background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)', fontFamily: '"Noto Sans JP", sans-serif', color: '#e2e8f0', position: 'relative', overflow: 'hidden' },
        glow1: { position: 'absolute', top: '-50%', right: '-20%', width: '600px', height: '600px', background: 'radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%)', borderRadius: '50%', pointerEvents: 'none' },
        glow2: { position: 'absolute', bottom: '-30%', left: '-10%', width: '500px', height: '500px', background: 'radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%)', borderRadius: '50%', pointerEvents: 'none' },
        content: { maxWidth: '600px', margin: '0 auto', padding: '40px 20px', position: 'relative', zIndex: 1 },
        card: { background: 'rgba(255,255,255,0.05)', backdropFilter: 'blur(10px)', borderRadius: '24px', padding: '24px', marginBottom: '16px', border: '1px solid rgba(255,255,255,0.1)' },
        button: { background: 'linear-gradient(135deg, #6366f1, #8b5cf6)', color: '#fff', border: 'none', padding: '16px 32px', borderRadius: '16px', cursor: 'pointer', fontWeight: '600', fontSize: '16px' },
        buttonSecondary: { background: 'rgba(255,255,255,0.1)', color: '#e2e8f0', border: '1px solid rgba(255,255,255,0.1)', padding: '16px 32px', borderRadius: '16px', cursor: 'pointer', fontWeight: '600', fontSize: '16px' },
        input: { width: '100%', background: 'rgba(255,255,255,0.1)', border: '2px solid rgba(255,255,255,0.1)', borderRadius: '16px', padding: '18px 24px', color: '#fff', fontSize: '18px', outline: 'none', boxSizing: 'border-box' },
      };

      return (
        <div style={styles.container}>
          <div style={styles.glow1} />
          <div style={styles.glow2} />

          {showNotification && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, background: 'linear-gradient(90deg, #6366f1, #8b5cf6)', padding: '16px', textAlign: 'center', zIndex: 1000 }}>
              <p style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>â˜• 30åˆ†çµŒéï¼æ¯æŠœãã®æ™‚é–“ã§ã™</p>
              <div style={{ marginTop: '12px', display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                <button onClick={startQuiz} style={{ background: '#fff', color: '#6366f1', border: 'none', padding: '10px 24px', borderRadius: '24px', cursor: 'pointer', fontWeight: '600' }}>âœï¸ å˜èªãƒ†ã‚¹ãƒˆ</button>
                <button onClick={() => { setScreen('chat'); setShowNotification(false); }} style={{ background: 'rgba(255,255,255,0.2)', color: '#fff', border: '1px solid rgba(255,255,255,0.3)', padding: '10px 24px', borderRadius: '24px', cursor: 'pointer', fontWeight: '600' }}>ğŸŒ± ãŠã—ã‚ƒã¹ã‚Š</button>
                <button onClick={resetTimer} style={{ background: 'transparent', color: 'rgba(255,255,255,0.7)', border: 'none', padding: '10px 24px', cursor: 'pointer' }}>ã‚¹ã‚­ãƒƒãƒ— â†’</button>
              </div>
            </div>
          )}

          <div style={styles.content}>
            <header style={{ textAlign: 'center', marginBottom: '32px' }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px' }}>
                <span style={{ fontSize: '36px' }}>â˜•</span>
                <h1 style={{ fontSize: '28px', fontWeight: '700', background: 'linear-gradient(90deg, #818cf8, #a78bfa)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', margin: 0 }}>Word Break</h1>
              </div>
              <p style={{ color: '#94a3b8', marginTop: '8px', fontSize: '14px' }}>ä½œæ¥­ã®åˆé–“ã®ã€ã‚†ã‚‹ã‚„ã‹å˜èªå­¦ç¿’</p>
            </header>

            {screen === 'home' && (
              <div style={{ animation: 'fadeIn 0.5s ease' }}>
                <div style={{ ...styles.card, padding: '32px' }}>
                  <div style={{ textAlign: 'center' }}>
                    <p style={{ color: '#94a3b8', marginBottom: '16px', fontSize: '14px' }}>ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</p>
                    <div style={{ fontSize: '64px', fontWeight: '700', fontFamily: 'monospace', letterSpacing: '4px', color: isTimerRunning ? '#818cf8' : '#e2e8f0' }}>
                      {String(timerMinutes).padStart(2, '0')}:{String(timerSeconds).padStart(2, '0')}
                    </div>
                    <div style={{ marginTop: '24px', display: 'flex', gap: '12px', justifyContent: 'center' }}>
                      <button onClick={() => setIsTimerRunning(!isTimerRunning)} style={{ ...styles.button, background: isTimerRunning ? 'rgba(248, 113, 113, 0.2)' : styles.button.background }}>{isTimerRunning ? 'â¸ ä¸€æ™‚åœæ­¢' : 'â–¶ ä½œæ¥­é–‹å§‹'}</button>
                      <button onClick={() => { setTimerMinutes(30); setTimerSeconds(0); }} style={{ ...styles.buttonSecondary, padding: '14px 20px' }}>ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '12px', marginBottom: '16px' }}>
                  <button onClick={startQuiz} style={{ ...styles.button, flex: 1, padding: '24px', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '24px' }}>âœï¸</span> å˜èªãƒ†ã‚¹ãƒˆ
                  </button>
                  <button onClick={() => setScreen('chat')} style={{ ...styles.buttonSecondary, flex: 1, padding: '24px', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '24px' }}>ğŸŒ±</span> ãŠã—ã‚ƒã¹ã‚Š
                  </button>
                </div>

                <div style={{ ...styles.card, padding: '16px' }}>
                  <p style={{ color: '#94a3b8', marginBottom: '12px', fontSize: '12px', textAlign: 'center' }}>ğŸ“‚ å­¦ç¿’ã‚«ãƒ†ã‚´ãƒª</p>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {Object.entries(categoryNames).map(([key, name]) => (
                      <button key={key} onClick={() => setCategory(key)} style={{ flex: 1, background: category === key ? `linear-gradient(135deg, ${categoryColors[key]}33, ${categoryColors[key]}11)` : 'rgba(255,255,255,0.05)', border: category === key ? `2px solid ${categoryColors[key]}` : '2px solid transparent', color: category === key ? categoryColors[key] : '#94a3b8', padding: '12px 8px', borderRadius: '10px', cursor: 'pointer', fontWeight: '600', fontSize: '12px' }}>
                        {key === 'toeic' ? 'ğŸ’¼' : 'ğŸ’¬'} {name}
                      </button>
                    ))}
                  </div>
                </div>

                <div style={{ ...styles.card, padding: '16px' }}>
                  <p style={{ color: '#94a3b8', marginBottom: '12px', fontSize: '12px', textAlign: 'center' }}>ğŸ“Š é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«</p>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {Object.entries(levelNames).map(([key, name]) => (
                      <button key={key} onClick={() => setLevel(key)} style={{ flex: 1, background: level === key ? `linear-gradient(135deg, ${levelColors[key]}33, ${levelColors[key]}11)` : 'rgba(255,255,255,0.05)', border: level === key ? `2px solid ${levelColors[key]}` : '2px solid transparent', color: level === key ? levelColors[key] : '#94a3b8', padding: '12px', borderRadius: '10px', cursor: 'pointer', fontWeight: '600', fontSize: '12px' }}>{name}</button>
                    ))}
                  </div>
                </div>

                {learningStats.totalQuizzes > 0 && (
                  <div style={{ ...styles.card, padding: '16px' }}>
                    <p style={{ color: '#94a3b8', fontSize: '12px', marginBottom: '12px' }}>ğŸ“Š ä»Šæ—¥ã®å­¦ç¿’çŠ¶æ³</p>
                    <div style={{ display: 'flex', gap: '20px' }}>
                      <div><span style={{ fontSize: '24px', fontWeight: '700', color: '#818cf8' }}>{learningStats.totalQuizzes}</span><span style={{ color: '#64748b', fontSize: '12px', marginLeft: '4px' }}>å›</span></div>
                      <div><span style={{ fontSize: '24px', fontWeight: '700', color: '#4ade80' }}>{learningStats.totalQuestions > 0 ? Math.round(learningStats.correctAnswers / learningStats.totalQuestions * 100) : 0}%</span><span style={{ color: '#64748b', fontSize: '12px', marginLeft: '4px' }}>æ­£ç­”ç‡</span></div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {screen === 'quiz' && questions.length > 0 && (
              <div style={{ animation: 'fadeIn 0.5s ease' }}>
                <div style={{ background: 'rgba(255,255,255,0.1)', borderRadius: '8px', height: '8px', marginBottom: '32px', overflow: 'hidden' }}>
                  <div style={{ background: 'linear-gradient(90deg, #6366f1, #8b5cf6)', height: '100%', width: `${(currentQuestion + 1) / questions.length * 100}%`, transition: 'width 0.3s ease', borderRadius: '8px' }} />
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <span style={{ color: categoryColors[category], fontSize: '12px', background: `${categoryColors[category]}22`, padding: '4px 12px', borderRadius: '12px' }}>{categoryNames[category]} / {levelNames[level]}</span>
                  <span style={{ color: '#94a3b8' }}>{currentQuestion + 1} / {questions.length}</span>
                </div>

                <div style={{ ...styles.card, padding: '40px 32px', textAlign: 'center' }}>
                  <p style={{ color: questions[currentQuestion].isEnglishToJapanese ? '#60a5fa' : '#c084fc', fontSize: '14px', marginBottom: '8px', fontWeight: '600' }}>{questions[currentQuestion].questionLabel}</p>
                  <h2 style={{ fontSize: questions[currentQuestion].isEnglishToJapanese ? '36px' : '28px', fontWeight: '700', color: '#fff', margin: '16px 0', lineHeight: '1.4' }}>{questions[currentQuestion].question}</h2>
                  <p style={{ color: '#64748b', fontSize: '14px', fontStyle: 'italic' }}>ä¾‹: "{questions[currentQuestion].example}"</p>
                </div>

                {!showAnswer ? (
                  <div>
                    <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && userInput.trim() && handleSubmitAnswer()} placeholder={questions[currentQuestion].isEnglishToJapanese ? "æ—¥æœ¬èªã§å…¥åŠ›..." : "è‹±èªã§å…¥åŠ›..."} autoFocus style={{ ...styles.input, marginBottom: '16px' }} />
                    <button onClick={handleSubmitAnswer} disabled={!userInput.trim()} style={{ ...styles.button, width: '100%', opacity: userInput.trim() ? 1 : 0.5, cursor: userInput.trim() ? 'pointer' : 'not-allowed' }}>å›ç­”ã™ã‚‹</button>
                  </div>
                ) : (
                  <div style={{ background: lastAnswerResult.correct ? 'rgba(74, 222, 128, 0.15)' : 'rgba(248, 113, 113, 0.15)', borderRadius: '20px', padding: '24px', marginBottom: '16px', border: `1px solid ${lastAnswerResult.correct ? '#4ade80' : '#f87171'}`, animation: lastAnswerResult.correct ? 'bounce 0.5s ease' : 'shake 0.5s ease' }}>
                    <div style={{ fontSize: '48px', textAlign: 'center', marginBottom: '16px' }}>{lastAnswerResult.correct ? 'ğŸ‰' : 'ğŸ˜…'}</div>
                    <p style={{ textAlign: 'center', fontSize: '20px', fontWeight: '600', color: lastAnswerResult.correct ? '#4ade80' : '#f87171', marginBottom: '16px' }}>{lastAnswerResult.correct ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£...'}</p>
                    {!lastAnswerResult.correct && <div style={{ background: 'rgba(0,0,0,0.2)', borderRadius: '12px', padding: '16px', marginBottom: '12px' }}><p style={{ color: '#94a3b8', fontSize: '12px', marginBottom: '4px' }}>ã‚ãªãŸã®å›ç­”</p><p style={{ color: '#f87171', fontSize: '16px' }}>{lastAnswerResult.userAnswer || '(æœªå…¥åŠ›)'}</p></div>}
                    <div style={{ background: 'rgba(0,0,0,0.2)', borderRadius: '12px', padding: '16px' }}><p style={{ color: '#94a3b8', fontSize: '12px', marginBottom: '4px' }}>æ­£è§£</p><p style={{ color: '#4ade80', fontSize: '18px', fontWeight: '600' }}>{lastAnswerResult.correctAnswer}</p></div>
                    {lastAnswerResult.wasClose && !lastAnswerResult.correct && <p style={{ textAlign: 'center', color: '#facc15', fontSize: '14px', marginTop: '12px' }}>ğŸ’¡ æƒœã—ã„ï¼ã‚¹ãƒšãƒ«ã‚’ã‚‚ã†å°‘ã—ç¢ºèª</p>}
                  </div>
                )}
                {showAnswer && <button onClick={handleNextQuestion} style={{ ...styles.button, width: '100%' }}>{currentQuestion < questions.length - 1 ? 'æ¬¡ã®å•é¡Œã¸ â†’' : 'çµæœã‚’è¦‹ã‚‹'}</button>}
                <button onClick={() => setScreen('home')} style={{ display: 'block', margin: '24px auto 0', background: 'transparent', border: 'none', color: '#64748b', cursor: 'pointer', fontSize: '14px' }}>â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
              </div>
            )}

            {screen === 'result' && (() => {
              const feedback = generateFeedback(results, category, level);
              const correctCount = results.filter(r => r.correct).length;
              return (
                <div style={{ animation: 'fadeIn 0.5s ease' }}>
                  <div style={{ ...styles.card, padding: '40px', textAlign: 'center' }}>
                    <div style={{ fontSize: '72px', fontWeight: '700', background: correctCount >= 7 ? 'linear-gradient(135deg, #4ade80, #22d3ee)' : correctCount >= 5 ? 'linear-gradient(135deg, #facc15, #fb923c)' : 'linear-gradient(135deg, #f87171, #fb7185)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '8px' }}>{correctCount}/{results.length}</div>
                    <p style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px' }}>{feedback.message}</p>
                    <p style={{ color: '#94a3b8', fontSize: '14px' }}>{categoryNames[category]} / {levelNames[level]}</p>
                  </div>
                  <div style={{ background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))', borderRadius: '20px', padding: '24px', marginBottom: '16px', border: '1px solid rgba(99, 102, 241, 0.3)' }}>
                    <p style={{ color: '#a78bfa', fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>ğŸ¤– AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
                    <p style={{ color: '#e2e8f0', lineHeight: '1.7', marginBottom: '12px' }}>{feedback.advice}</p>
                    <p style={{ color: '#94a3b8', fontSize: '14px', fontStyle: 'italic' }}>{feedback.encouragement}</p>
                  </div>
                  <div style={{ ...styles.card, padding: '20px' }}>
                    <p style={{ color: '#94a3b8', fontSize: '14px', marginBottom: '16px' }}>ğŸ“ å›ç­”è©³ç´°</p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {results.map((result, idx) => (
                        <div key={idx} style={{ padding: '12px', background: result.correct ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)', borderRadius: '12px' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{result.correct ? 'âœ“' : 'âœ—'}</span>
                            <span style={{ fontWeight: '600' }}>{result.question}</span>
                            <span style={{ fontSize: '12px', color: result.isEnglishToJapanese ? '#60a5fa' : '#c084fc', marginLeft: 'auto' }}>{result.isEnglishToJapanese ? 'å’Œè¨³' : 'è‹±è¨³'}</span>
                          </div>
                          <div style={{ fontSize: '14px', color: '#94a3b8', marginLeft: '24px' }}>æ­£è§£: <span style={{ color: '#4ade80' }}>{result.correctAnswer}</span>{!result.correct && <span style={{ color: '#f87171', marginLeft: '12px' }}>(å…¥åŠ›: {result.userAnswer || 'æœªå…¥åŠ›'})</span>}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button onClick={startQuiz} style={{ ...styles.button, flex: 1 }}>ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
                    <button onClick={() => { resetTimer(); setScreen('home'); }} style={{ ...styles.buttonSecondary, flex: 1 }}>ğŸ’¼ ä½œæ¥­ã«æˆ»ã‚‹</button>
                  </div>
                </div>
              );
            })()}

            {screen === 'chat' && (
              <div style={{ animation: 'fadeIn 0.5s ease' }}>
                <div style={{ ...styles.card, minHeight: '400px', display: 'flex', flexDirection: 'column' }}>
                  <p style={{ textAlign: 'center', color: '#94a3b8', fontSize: '14px', marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>ğŸŒ± ãŠã—ã‚ƒã¹ã‚Šã‚¿ã‚¤ãƒ </p>
                  <div style={{ flex: 1, overflowY: 'auto', marginBottom: '16px', display: 'flex', flexDirection: 'column', gap: '12px', maxHeight: '300px' }}>
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} style={{ alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start', maxWidth: '80%' }}>
                        <div style={{ background: msg.role === 'user' ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : 'rgba(255,255,255,0.1)', padding: '14px 18px', borderRadius: msg.role === 'user' ? '20px 20px 4px 20px' : '20px 20px 20px 4px', lineHeight: '1.6', fontSize: '15px' }}>{msg.text}</div>
                      </div>
                    ))}
                    {isChatLoading && (
                      <div style={{ alignSelf: 'flex-start', maxWidth: '80%' }}>
                        <div style={{ background: 'rgba(255,255,255,0.1)', padding: '14px 18px', borderRadius: '20px 20px 20px 4px', lineHeight: '1.6', fontSize: '15px', color: '#94a3b8' }}>
                          <span style={{ display: 'inline-block', animation: 'pulse 1s infinite' }}>è€ƒãˆä¸­...</span>
                        </div>
                      </div>
                    )}
                  </div>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isChatLoading && sendChat()} placeholder="ä½•ã§ã‚‚è©±ã—ã¦ã¿ã¦ãã ã•ã„..." disabled={isChatLoading} style={{ flex: 1, background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', padding: '14px 18px', color: '#e2e8f0', fontSize: '15px', outline: 'none', opacity: isChatLoading ? 0.6 : 1 }} />
                    <button onClick={sendChat} disabled={isChatLoading || !chatInput.trim()} style={{ ...styles.button, padding: '14px 24px', opacity: (isChatLoading || !chatInput.trim()) ? 0.6 : 1, cursor: (isChatLoading || !chatInput.trim()) ? 'not-allowed' : 'pointer' }}>{isChatLoading ? '...' : 'é€ä¿¡'}</button>
                  </div>
                </div>
                <button onClick={() => setScreen('home')} style={{ display: 'block', margin: '24px auto 0', background: 'transparent', border: 'none', color: '#64748b', cursor: 'pointer', fontSize: '14px' }}>â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<WordBreakApp />);
  </script>
</body>
</html>
